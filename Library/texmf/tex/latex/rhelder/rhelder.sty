\NeedsTeXFormat{LaTeX2e}[2021/11/15]
\ProvidesPackage{rhelder}[2024/11/28 Russell Wright Helder's style file]

\RequirePackage{etoolbox}

\DeclareOption{biblatex}{\booltrue{biblatex}}
\DeclareOption{doublespaced}{\booltrue{doublespaced}}
\DeclareOption{misguided}{\booltrue{misguided}}
\DeclareOption{anonymous}{\boolfalse{author}\booltrue{anonymous}}
\DeclareOption{notranslit}{\boolfalse{translit}}

\newbool{biblatex}
\newbool{translit}
\newbool{author}
\newbool{anonymous}
\newbool{doublespaced}
\newbool{misguided}

\booltrue{translit}
\booltrue{author}

\ProcessOptions\relax

\RequirePackage{fontspec}
\RequirePackage{pifont}
\RequirePackage[
  shorthands=off,
  latin,
  english.american,
]{babel}
\babelprovide[import=grc]{ancientgreek}
\RequirePackage{ragged2e}
\RequirePackage[babel]{microtype}
\RequirePackage[shortcuts]{extdash}
\RequirePackage[
  strict,
  autostyle,
  english=british,
  latin=britishquotes,
]{csquotes}
\PassOptionsToPackage{hyphens}{url}
\RequirePackage[indentfirst=false]{quoting}
\RequirePackage{enumitem}
\RequirePackage{geometry}
\RequirePackage{array}
\RequirePackage{booktabs}
\RequirePackage{iftex}
\AddToHook{begindocument/before}{\RequirePackage{hyperref}}

\protected\def\rh@error#1#2{\PackageError{rhelder}{#1}{#2.}}
\protected\def\rh@warning#1{\PackageWarning{rhelder}{#1}}
\protected\def\rh@info#1{\PackageInfo{rhelder}{#1}}

\ifbool{biblatex}{
  \RequirePackage[
    authordate,
    sbllos,
    autolang=hyphen,
    citereset=section,
    parentracker=false,
    pagetracker=false,
    doi=false,
    isbn=false,
    url=false,
    dashed=false,
    compresspages=true,
    formatbib=minwo,
  ]{biblatex-chicago}
  \addbibresource{my_library.bib}

  \DeclareSourcemap{%
    \maps[datatype=bibtex]{%
      \map[overwrite]{%
        \step[fieldsource=entrysubtype, match=classical, final]
        \step[
          fieldset=options,
          fieldvalue={,shorthandfirst=false,shorthandintro=short},
          append,
        ]
      }
    }
  }

  % Reset footnote-specific 'ibidtracker' at beginning of each footnote
  \NewCommandCopy\oldfootnotetext\footnotetext
  \RenewDocumentCommand{\footnotetext}{+m}{\oldfootnotetext{\mancite #1}}
}{}

\ifbool{doublespaced}{
  \RequirePackage{setspace}
  \doublespacing
  \ifbool{biblatex{\setlength{\bibitemsep}{0pt}}}{}
}{}

\ifbool{misguided}{
  \DeclareAutoPunct{.,}
  \renewcommand{\mktextquote}[6]{#1#2#4#5#3#6}
}{\ifbool{biblatex}{
  \DefineBibliographyExtras{american}{\stdpunctuation}
}}

\ifbool{author}{
  \author{Russell Wright Helder}
  \AddToHook{begindocument/before}{
    \hypersetup{pdfauthor={Russell Wright Helder}}
  }
}{}

\ifbool{anonymous}{
  \patchcmd{\@maketitle}{%
    {\large
      \lineskip .5em%
      \begin{tabular}[t]{c}%
        \@author
      \end{tabular}\par}%
    \vskip 1em%
  }{}{}{}
}{}

\setmainfont{Brill}
\babelprovide[hyphenrules=classiclatin]{latin}
\hyphenation{Prem-ise Prem-ises}

\clubpenalty=10000
\widowpenalty=10000

\DeclareQuoteStyle{ancientgreek}
  {\textquotedblleft}{\textquotedblright}
  {\textquoteleft}{\textquoteright}

% {<qopen>}{<text>}{<qclose>}{<punct>}{<tpunct>}{<cite>}
\renewcommand{\mktextquote}[6]{%
  \ifboolexpr{
    test {\notblank{#6}}
    and
    ( test {\ifstrequal{#4}{.}} or test {\ifstrequal{#4}{,}} )
  }%
  {%
    #1#2#3#6#4#5%
  }{%
    #1#2#4#3#6#5%
  }%
}

\ifbool{biblatex}{%
  \SetCiteCommand{\autocite}
  \renewcommand*{\mkcitation}[1]{ #1}
}{}

% 'french' 'babel' option redefines '\textellipsis' at beginning of document
\AtBeginDocument{%
  \RenewCommandCopy\textellipsis\rh@ellipsis
  \RenewDocumentCommand{\dots}{}{%
    \ifmmode\mathellipsis\else
    \@ifnextchar \bgroup {%
      \expandafter\rh@rmbraces\textellipsis%
    }{%
      \expandafter\textellipsis
    }%
    \fi
  }
  \RenewCommandCopy\ldots\dots
}

\renewcommand*{\mktextelp}{\rh@ellipsis}
\renewcommand*{\mktextelpins}[1]{\rh@ellipsis [#1]} %false, unstarred
\renewcommand*{\mktextinselp}[1]{[#1] \rh@ellipsis} %true, unstarred

\protected\def\rh@ellipsis{%
  \@ifnextchar \bgroup{%
    \rh@rmbraces\rh@elp@spaces
  }{%
    \rh@elp@spaces
  }%
}

\def\rh@rmbraces#1#2{#1}

\def\rh@elp@spaces{%
  \ifvmode
    \leavevmode
    \def\rh@elp@prespace{}%
  \else
    \def\rh@elp@prespace{\penalty 9999\@\space}%
    \unskip
  \fi
  \@ifnextchar .{%
    \rh@elp@mvperiodbefore
  }{%
    \rh@elp
    \@ifnextchar ' {%
    }{\@ifnextchar " {%
    }{\@ifnextchar ) {%
    }{\@ifnextchar \ {%
    }{\@ifnextchar ~ {%
    }{\@ifnextchar \/ {%
    }{\@ifnextchar \footnote {%
    }{\@ifnextchar \footnotemark {%
    }{\@ifnextchar \csq@qclose@i {%
    }{\@ifnextchar \rh@qclose {%
      \global\booltrue{rh@end@ellipsis}%
    }{%
      \@\space
    }}}}}}}}}}%
  }%
}

\def\rh@elp@mvperiodbefore#1{%
  \@gobble{#1}%
  .\rh@elp
  \@ifnextchar \csq@qclose@i {%
  }{\@ifnextchar \rh@qclose {%
  }{%
  \@\space
  }}%
}

\def\rh@elp{\rh@elp@prespace .\@\nobreak\space .\@\nobreak\space .}

\patchcmd{\csq@tquote@i}{\endgroup}{%
  \rh@csq@check{#5}{#6}{#8}\endgroup
}{}{}

\def\rh@csq@check#1#2#3{%
  \ifboolexpr{
    test {\ifstrequal{#2}{;}} or test {\ifstrequal{#2}{:}}
  }%
  {%
    \rh@warning{%
      You passed ';' or ':' to '\string\texqtuote'
      as terminal punctuation.%
    }%
  }{}%
  \ifboolexpr{
    test {\notblank{#2}} and test {\notblank{#3}}
  }%
  {%
    \rh@warning{%
      You passed both terminal and trailing punctuation
      to '\string\textquote'.%
    }%
  }{}%
  \ifbool{rh@end@ellipsis}{%
    \ifboolexpr{
      test {\ifstrequal{#3}{.}} and test {\ifblank{#1}}
    }%
    {%
      \rh@warning{%
        A period is trailing a '\string\textquote'
        that ends in an ellipsis.%
      }%
    }{}%
    \global\boolfalse{rh@end@ellipsis}%
  }{}%
}

\newbool{rh@end@ellipsis}

\patchcmd{\csq@quote@i}{#3}{#3\rh@qclose}{}{}
\patchcmd{\csq@quote@ii}{#3}{#3\rh@qclose}{}{}

\def\rh@qclose{}

\SetBlockEnvironment{quoting}
\RenewCommandCopy\quotation\quoting
\RenewCommandCopy\endquotation\endquoting
\RenewCommandCopy\quote\quoting
\RenewCommandCopy\endquote\endquoting

\NewDocumentCommand{\gensg}{m}{#1's}
\NewDocumentCommand{\genpl}{m}{%
  \begingroup
  \def\rh@tempa{}%
  \rh@genpl@do#1\relax
  \endgroup
}
\NewDocumentCommand{\gensgpl}{m}{\genpl{#1}}
\NewCommandCopy\genorg\gensgpl
\NewCommandCopy\genforsake\gensgpl

\def\rh@genpl@do#1{%
  \appto{\rh@tempa}{#1}%
  \let\rh@genpl@last #1%
  \futurelet\rh@genpl@next\rh@genpl@iterate
}

\def\rh@genpl@iterate{%
  \ifx\rh@genpl@next\relax\relax
    \ifx\rh@genpl@last s\relax
      \rh@tempa '%
    \else
      \rh@tempa 's%
    \fi
    \def\rh@genpl@do{}%
  \else\ifx\rh@genpl@next\@sptoken\relax
    \appto{\rh@tempa}{\space}%
  \fi\fi
  \rh@genpl@do
}

\setlist[itemize,2]{label=\ding{118}}
\setlist[itemize,3]{label=\ding{66}}

\newlist{outline}{enumerate}{5}
\setlist[outline,1]{label=\Roman*.}
\setlist[outline,2]{label=\Alph*.}
\setlist[outline,3]{label=\arabic*.}
\setlist[outline,4]{label=\alph*.}
\setlist[outline,5]{label=\roman*.}

% Make paragraph spacing within list same as outside of list
\setlist[1,2,3,4,5]{listparindent=1\parindent, parsep=0pt}

\newlist{enumerate*}{enumerate*}{1}
\setlist[enumerate*]{label=\Alph*.}

\ifbool{@twocolumn}{
  \geometry{hscale=0.7635}
}{\ifbool{LuaTeX}{
  \geometry{hscale=\directlua{tex.print(0.03680 * \f@size + 0.1936)}}
}{
  \geometry{pass}
}}

\AddToHook{begindocument/before}{
  \hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=magenta,
    citecolor=black,
    urlcolor=blue,
    pdfpagemode=UseNone,
    pdftitle={\@title},
  }
  \urlstyle{same}
}

\NewCommandCopy\texttitle\emph
\NewCommandCopy\alialingua\emph
\NewCommandCopy\define\emph
\NewCommandCopy\attn\textbf

\ifbool{translit}{% TODO add hyphenation patterns
  \NewDocumentCommand{\boulesis}{}{\alialingua{boulēsis}}
  \NewDocumentCommand{\Boulesis}{}{\alialingua{Boulēsis}}
  \NewDocumentCommand{\bouleseis}{}{\alialingua{boulēseis}}
  \NewDocumentCommand{\Bouleseis}{}{\alialingua{Boulēseis}}
  \NewDocumentCommand{\nous}{}{\alialingua{nous}}
  \NewDocumentCommand{\Nous}{}{\alialingua{Nous}}
  \NewDocumentCommand{\phantasiai}{}{\alialingua{phantasiai}}
  \NewDocumentCommand{\Phantasiai}{}{\alialingua{Phantasiai}}
  \NewDocumentCommand{\phantasia}{}{\alialingua{phantasia}}
  \NewDocumentCommand{\Phantasia}{}{\alialingua{Phantasia}}
  \NewDocumentCommand{\phantasmata}{}{\alialingua{phantasmata}}
  \NewDocumentCommand{\Phantasmata}{}{\alialingua{Phantasmata}}
  \NewDocumentCommand{\phantasma}{}{\alialingua{phantasma}}
  \NewDocumentCommand{\Phantasma}{}{\alialingua{Phantasma}}
  \NewDocumentCommand{\phronesis}{}{\alialingua{phronēsis}}
  \NewDocumentCommand{\Phronesis}{}{\alialingua{Phronēsis}}
  \NewDocumentCommand{\thumos}{}{\alialingua{thumos}}
  \NewDocumentCommand{\Thumos}{}{\alialingua{Thumos}}
}{%
  \NewDocumentCommand{\boulesis}{}{%
    \foreignlanguage{ancientgreek}{βούλησις}%
  }
  \NewDocumentCommand{\Boulesis}{}{%
    \foreignlanguage{ancientgreek}{Βούλησις}%
  }
  \NewDocumentCommand{\bouleseis}{}{%
    \foreignlanguage{ancientgreek}{βουλήσεις}%
  }
  \NewDocumentCommand{\Bouleseis}{}{%
    \foreignlanguage{ancientgreek}{Βουλήσεις}%
  }
  \NewDocumentCommand{\nous}{}{%
    \foreignlanguage{ancientgreek}{νοῦς}%
  }
  \NewDocumentCommand{\Nous}{}{%
    \foreignlanguage{ancientgreek}{Νοῦς}%
  }
  \NewDocumentCommand{\phantasiai}{}{%
    \foreignlanguage{ancientgreek}{φαντασίαι}%
  }
  \NewDocumentCommand{\Phantasiai}{}{%
    \foreignlanguage{ancientgreek}{Φαντασίαι}%
  }
  \NewDocumentCommand{\phantasia}{}{%
    \foreignlanguage{ancientgreek}{φαντασία}%
  }
  \NewDocumentCommand{\Phantasia}{}{%
    \foreignlanguage{ancientgreek}{Φαντασία}%
  }
  \NewDocumentCommand{\phantasmata}{}{%
    \foreignlanguage{ancientgreek}{φαντάσματα}%
  }
  \NewDocumentCommand{\Phantasmata}{}{%
    \foreignlanguage{ancientgreek}{Φαντάσματα}%
  }
  \NewDocumentCommand{\phantasma}{}{%
    \foreignlanguage{ancientgreek}{φάντασμα}%
  }
  \NewDocumentCommand{\Phantasma}{}{%
    \foreignlanguage{ancientgreek}{Φάντασμα}%
  }
  \NewDocumentCommand{\phronesis}{}{%
    \foreignlanguage{ancientgreek}{φρόνησις}%
  }
  \NewDocumentCommand{\Phronesis}{}{%
    \foreignlanguage{ancientgreek}{Φρόνησις}%
  }
  \NewDocumentCommand{\thumos}{}{%
    \foreignlanguage{ancientgreek}{θυμός}%
  }
  \NewDocumentCommand{\Thumos}{}{%
    \foreignlanguage{ancientgreek}{Θυμός}%
  }
}

\NewDocumentCommand{\akrates}{}{%
  \foreignlanguage{ancientgreek}{ἀκρατής}%
}
\NewDocumentCommand{\Akrates}{}{%
  \foreignlanguage{ancientgreek}{Ἀκρατής}%
}
\NewDocumentCommand{\Deinos}{}{%
  \foreignlanguage{ancientgreek}{Δεινός}%
}
\NewDocumentCommand{\deinos}{}{%
  \foreignlanguage{ancientgreek}{δεινός}%
}
\NewDocumentCommand{\Deinotes}{}{%
  \foreignlanguage{ancientgreek}{Δεινότης}%
}
\NewDocumentCommand{\deinotes}{}{%
  \foreignlanguage{ancientgreek}{δεινότης}%
}
\NewDocumentCommand{\enkrates}{}{%
  \foreignlanguage{ancientgreek}{ἐγκρατής}%
}
\NewDocumentCommand{\Enkrates}{}{%
  \foreignlanguage{ancientgreek}{Ἐγκρατής}%
}
\NewDocumentCommand{\epithumia}{}{%
  \foreignlanguage{ancientgreek}{ἐπιθυμία}%
}
\NewDocumentCommand{\Epithumia}{}{%
  \foreignlanguage{ancientgreek}{Ἐπιθυμία}%
}
\NewDocumentCommand{\ergon}{}{%
  \foreignlanguage{ancientgreek}{ἔργον}%
}
\NewDocumentCommand{\Ergon}{}{%
  \foreignlanguage{ancientgreek}{Ἔργον}%
}
\NewDocumentCommand{\Euboulia}{}{%
  \foreignlanguage{ancientgreek}{Εὐβουλία}%
}
\NewDocumentCommand{\euboulia}{}{%
  \foreignlanguage{ancientgreek}{εὐβουλία}%
}
\NewDocumentCommand{\Krisis}{}{%
  \foreignlanguage{ancientgreek}{Κρίσις}%
}
\NewDocumentCommand{\krisis}{}{%
  \foreignlanguage{ancientgreek}{κρίσις}%
}
\NewDocumentCommand{\Logoi}{}{%
  \foreignlanguage{ancientgreek}{Λόγοι}%
}
\NewDocumentCommand{\logoi}{}{%
  \foreignlanguage{ancientgreek}{λόγοι}%
}
\NewDocumentCommand{\Logos}{}{%
  \foreignlanguage{ancientgreek}{Λόγος}%
}
\NewDocumentCommand{\logos}{}{%
  \foreignlanguage{ancientgreek}{λόγος}%
}
\NewDocumentCommand{\orexis}{}{%
  \foreignlanguage{ancientgreek}{ὄρεξις}%
}
\NewDocumentCommand{\Orexis}{}{%
  \foreignlanguage{ancientgreek}{Ὄρεξις}%
}
\NewDocumentCommand{\Pathemata}{}{%
  \foreignlanguage{ancientgreek}{Παθήματα}%
}
\NewDocumentCommand{\pathemata}{}{%
  \foreignlanguage{ancientgreek}{παθήματα}%
}
\NewDocumentCommand{\Phronime}{}{%
  \foreignlanguage{ancientgreek}{Φρονίμη}%
}
\NewDocumentCommand{\phronime}{}{%
  \foreignlanguage{ancientgreek}{φρονίμη}%
}
\NewDocumentCommand{\Phronimoi}{}{%
  \foreignlanguage{ancientgreek}{Φρόνιμοι}%
}
\NewDocumentCommand{\phronimoi}{}{%
  \foreignlanguage{ancientgreek}{φρόνιμοι}%
}
\NewDocumentCommand{\Phronimos}{}{%
  \foreignlanguage{ancientgreek}{Φρόνιμος}%
}
\NewDocumentCommand{\phronimos}{}{%
  \foreignlanguage{ancientgreek}{φρόνιμος}%
}
\NewDocumentCommand{\Prohaireseis}{}{%
  \foreignlanguage{ancientgreek}{Προαιρέσεις}%
}
\NewDocumentCommand{\prohaireseis}{}{%
  \foreignlanguage{ancientgreek}{προαιρέσεις}%
}
\NewDocumentCommand{\Prohairesis}{}{%
  \foreignlanguage{ancientgreek}{Προαίρεσις}%
}
\NewDocumentCommand{\prohairesis}{}{%
  \foreignlanguage{ancientgreek}{προαίρεσις}%
}

\NewDocumentCommand{\doxastikon}{s}{%
    \foreignlanguage{ancientgreek}{\IfBooleanT{#1}{τὸ }δοξαστικόν}%
}

\NewDocumentCommand{\Doxastikon}{s}{%
    \IfBooleanTF{#1}{%
        \foreignlanguage{ancientgreek}{Τὸ δοξαστικόν}%
    }{%
        \foreignlanguage{ancientgreek}{Δοξαστικόν}%
    }%
}

\NewDocumentCommand{\ToDoxastikon}{}{%
  \foreignlanguage{ancientgreek}{Τὸ Δοξαστικόν}%
}

\NewDocumentCommand{\kalon}{s}{%
    \foreignlanguage{ancientgreek}{\IfBooleanT{#1}{τὸ }καλόν}%
}

\NewDocumentCommand{\Kalon}{s}{%
    \IfBooleanTF{#1}{%
        \foreignlanguage{ancientgreek}{Τὸ καλόν}%
    }{%
        \foreignlanguage{ancientgreek}{Καλόν}%
    }%
}

\NewDocumentCommand{\ToKalon}{}{%
  \foreignlanguage{ancientgreek}{Τὸ Καλόν}%
}

\NewDocumentCommand{\logistikon}{s}{%
    \foreignlanguage{ancientgreek}{\IfBooleanT{#1}{τὸ }λογιστικόν}%
}

\NewDocumentCommand{\Logistikon}{s}{%
    \IfBooleanTF{#1}{%
        \foreignlanguage{ancientgreek}{Τὸ λογιστικόν}%
    }{%
        \foreignlanguage{ancientgreek}{Λογιστικόν}%
    }%
}

\NewDocumentCommand{\ToLogistikon}{}{%
  \foreignlanguage{ancientgreek}{Τὸ Λογιστικόν}%
}
