\NeedsTeXFormat{LaTeX2e}[2021/11/15]
\ProvidesPackage{rhelder}[Russell Wright Helder's style file]

\RequirePackage{etoolbox}

% Options {{{1

\DeclareKeys[rhelder]{
  biblatex.code = \SetKeys[rh@biblatex]{#1},
  doublespaced.if = rh@doublespaced,
  anonymous.if = rh@anonymous,
  author.code =
    \notbool{rh@anonymous}{
      \author{#1}
      \AddToHook{package/hyperref/after}{\hypersetup{pdfauthor=#1}}
    }{},
  translit.if = rh@translit,
}

\DeclareKeys[rh@biblatex]{
  authordate.code = \def\rh@biblatex@style{authordate},
  notes.code = \def\rh@biblatex@style{notes},
}
\let\rh@biblatex@style\empty

\DeclareUnknownKeyHandler[rh@biblatex]{
  \eappto\rh@biblatex@opts{\ifblank{#2}{#1}{#1=#2},}
}

\def\rh@biblatex@notes{
  \epreto\rh@biblatex@opts{
    autolang=hyphen,
    citereset=section,
    pagetracker=false,
    doi=false,
    isbn=false,
    url=false,
    dashed=false,
    compresspages=true,
    formatbib=minwo,
  }
  \expandafter\RequirePackage\expandafter[\rh@biblatex@style]{biblatex-chicago}
  \expandafter\ExecuteBibliographyOptions\expandafter{\rh@biblatex@opts}
}

\def\rh@biblatex@authordate{
  \epreto\rh@biblatex@opts{cmslos=false,}
  \rh@biblatex@notes
}

\SetKeys[rhelder]{
  author={Russell Wright Helder},
  translit=true,
}

\ProcessKeyOptions

% Load packages {{{1

\AddToHook{begindocument/before}{\RequirePackage{hyperref}}

\RequirePackage[
  shorthands=off,
  latin,
  english.american,
]{babel}
\babelprovide[import=grc]{ancientgreek}

\RequirePackage{ragged2e}
\RequirePackage[babel]{microtype}
\ifbool{rh@doublespaced}{\RequirePackage{setspace}}{}
\RequirePackage[shortcuts]{extdash}
\RequirePackage[
  strict,
  autostyle,
  english=british,
  latin=britishquotes,
]{csquotes}
\PassOptionsToPackage{hyphens}{url}
\RequirePackage{cmos}

\RequirePackage[indentfirst=false]{quoting}
\RequirePackage{enumitem}

\RequirePackage{geometry}

\RequirePackage{array}
\RequirePackage{booktabs}

\RequirePackage{pifont}

\csuse{rh@biblatex@\rh@biblatex@style}
\undef\rh@biblatex@authordate
\undef\rh@biblatex@notes
\undef\rh@biblatex@commonopts
\undef\rh@biblatex@opts

\RequirePackage{iftex}

% Configure packages {{{1

\AddToHook{package/hyperref/after}{
  \hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=magenta,
    citecolor=black,
    urlcolor=blue,
    pdfpagemode=UseNone,
    pdftitle=\@title,
  }
  \urlstyle{same}
}

\babelfont{rm}{Brill}
\babelprovide[hyphenrules=classiclatin]{latin}

\ifbool{rh@doublespaced}{
  \doublespacing
  \IfPackageLoadedTF{biblatex-chicago}{\setlength{\bibitemsep}{0pt}}{}
}{}

\DeclareQuoteStyle{ancientgreek}
  {\textquotedblleft}{\textquotedblright}
  {\textquoteleft}{\textquoteright}
\IfPackageLoadedTF{biblatex-chicago}{\SetCiteCommand{\autocite}}{}

\SetBlockEnvironment{quoting}
\RenewCommandCopy\quotation\quoting
\RenewCommandCopy\endquotation\endquoting
\RenewCommandCopy\quote\quoting
\RenewCommandCopy\endquote\endquoting

\setlist[itemize,2]{label=\ding{118}}
\setlist[itemize,3]{label=\ding{66}}
\newlist{outline}{enumerate}{5}
\setlist[outline,1]{label=\Roman*.}
\setlist[outline,2]{label=\Alph*.}
\setlist[outline,3]{label=\arabic*.}
\setlist[outline,4]{label=\alph*.}
\setlist[outline,5]{label=\roman*.}
% Define inline 'enumerate'
\newlist{enumerate*}{enumerate*}{1}
\setlist[enumerate*]{label=\Alph*.}
% Make paragraph spacing within list same as outside of list
\setlist{listparindent=\parindent, parsep=\parskip}

\IfPackageLoadedTF{biblatex-chicago}{%
  \addbibresource{my_library.bib}
  \DeclareSourcemap{%
    \maps[datatype=bibtex]{%
      \map[overwrite]{%
        \step[fieldsource=entrysubtype, match=classical, final]
        \step[
          fieldset=options,
          fieldvalue={,shorthandfirst=false,shorthandintro=short},
          append,
        ]
      }
    }
  }
  % Reset footnote-specific 'ibidtracker' at beginning of each footnote
  \NewCommandCopy\footnotetextCopy\footnotetext % FIXME find better approach
  \RenewDocumentCommand{\footnotetext}{+m}{\footnotetextCopy{\mancite #1}}
}{}

% Page layout {{{1

\newlength\rh@upperletters
\newlength\rh@lowerletters
\newlength\rh@spaces
\newlength\rh@others@nondigit
\newlength\rh@others@digit
\newlength\rh@allprintablechars
\newlength\rh@linelength
\newlength\rh@maxtextwidth
\newlength\rh@maxtextwidth@twocol
\newlength\rh@maxtextheight
\newcounter{rh@maxlines}
\newlength\rh@textheight

\NewDocumentCommand{\settextwidth}{O{0}}{%
  % Determine an average length of a line of 66 characters
  \settowidth\rh@upperletters{%
    ABCDEFGHIJKLMNOPQRSTUVWXYZ%
  }
  \settowidth\rh@lowerletters{%
    abcdefghijklmnopqrstuvwxyz%
  }
  \settowidth\rh@spaces{%
    \spacefactor\sfcode`. \space
    \spacefactor\sfcode`a \space
  }
  \settowidth\rh@others@nondigit{%
    .,:;!?()'"-%
  }
  \settowidth\rh@others@digit{%
    0123456789%
  }
  \setlength\rh@allprintablechars{\rh@upperletters}
  \addtolength\rh@allprintablechars{60\rh@lowerletters}
  \addtolength\rh@allprintablechars{100\rh@spaces}
  \addtolength\rh@allprintablechars{5\rh@others@nondigit}
  \addtolength\rh@allprintablechars{\rh@others@digit}
  \setlength\rh@linelength{\dimeval{\rh@allprintablechars / 1851 * (69 + #1)}}

  \setlength\rh@maxtextwidth{\dimeval{\paperwidth - 2in}}
  \setlength\rh@maxtextwidth@twocol{2\rh@linelength}
  \addtolength\rh@maxtextwidth@twocol{\columnsep}
  \addtolength\rh@maxtextwidth@twocol{\columnseprule}

  % Don't exceed max textwidth (see documentation for 'classes')
  \ifbool{@twocolumn}{
    \ifdimgreater{\rh@maxtextwidth@twocol}{\rh@maxtextwidth}{
      \geometry{textwidth=\rh@maxtextwidth}
    }{
      \geometry{textwidth=\rh@maxtextwidth@twocol}
    }
  }{
    \ifdimgreater{\rh@linelength}{\rh@maxtextwidth}{
      \geometry{textwidth=\rh@maxtextwidth}
    }{
      \geometry{textwidth=\rh@linelength}
    }
  }
}

\NewDocumentCommand{\settextheight}{O{0}}{
  \setlength\rh@maxtextheight{\paperheight}
  \addtolength\rh@maxtextheight{-2in}
  \addtolength\rh@maxtextheight{-\headheight}
  \addtolength\rh@maxtextheight{-\headsep}
  \addtolength\rh@maxtextheight{-\footskip}

  \divide\rh@maxtextheight by \baselineskip
  \setcounter{rh@maxlines}{\rh@maxtextheight}
  \addtocounter{rh@maxlines}{-1}

  \setlength\rh@textheight{\value{rh@maxlines}\baselineskip}
  \addtolength\rh@textheight{\topskip}
  \addtolength\rh@textheight{#1\baselineskip}
  \geometry{textheight=\rh@textheight}
}

\settextwidth
\settextheight

% Package configuration and macros {{{1

\clubpenalty=10000
\widowpenalty=10000
\hyphenation{Prem-ise Prem-ises}

\ifbool{rh@anonymous}{
  \patchcmd{\@maketitle}{%
    {\large
      \lineskip .5em%
      \begin{tabular}[t]{c}%
        \@author
      \end{tabular}\par}%
    \vskip 1em%
  }{}{}{}
}{}

% Macros denoting logical structure
\NewCommandCopy\texttitle\emph
\NewCommandCopy\alialingua\emph
\NewCommandCopy\define\emph
\NewCommandCopy\attn\textbf

% Greek words {{{2

\NewDocumentCommand{\akrates}{}{%
  \foreignlanguage{ancientgreek}{ἀκρατής}%
}

\NewDocumentCommand{\Akrates}{}{%
  \foreignlanguage{ancientgreek}{Ἀκρατής}%
}

\NewDocumentCommand{\Bouleseis}{}{%
  \foreignlanguage{ancientgreek}{Βουλήσεις}%
}

\NewDocumentCommand{\bouleseis}{}{%
  \foreignlanguage{ancientgreek}{βουλήσεις}%
}

\NewDocumentCommand{\Boulesis}{}{%
  \foreignlanguage{ancientgreek}{Βούλησις}%
}

\NewDocumentCommand{\boulesis}{}{%
  \foreignlanguage{ancientgreek}{βούλησις}%
}

\NewDocumentCommand{\Deinos}{}{%
  \foreignlanguage{ancientgreek}{Δεινός}%
}

\NewDocumentCommand{\deinos}{}{%
  \foreignlanguage{ancientgreek}{δεινός}%
}

\NewDocumentCommand{\Deinotes}{}{%
  \foreignlanguage{ancientgreek}{Δεινότης}%
}

\NewDocumentCommand{\deinotes}{}{%
  \foreignlanguage{ancientgreek}{δεινότης}%
}

\NewDocumentCommand{\enkrates}{}{%
  \foreignlanguage{ancientgreek}{ἐγκρατής}%
}

\NewDocumentCommand{\Enkrates}{}{%
  \foreignlanguage{ancientgreek}{Ἐγκρατής}%
}

\NewDocumentCommand{\epithumia}{}{%
  \foreignlanguage{ancientgreek}{ἐπιθυμία}%
}

\NewDocumentCommand{\Epithumia}{}{%
  \foreignlanguage{ancientgreek}{Ἐπιθυμία}%
}

\NewDocumentCommand{\ergon}{}{%
  \foreignlanguage{ancientgreek}{ἔργον}%
}

\NewDocumentCommand{\Ergon}{}{%
  \foreignlanguage{ancientgreek}{Ἔργον}%
}

\NewDocumentCommand{\Euboulia}{}{%
  \foreignlanguage{ancientgreek}{Εὐβουλία}%
}

\NewDocumentCommand{\euboulia}{}{%
  \foreignlanguage{ancientgreek}{εὐβουλία}%
}

\NewDocumentCommand{\Krisis}{}{%
  \foreignlanguage{ancientgreek}{Κρίσις}%
}

\NewDocumentCommand{\krisis}{}{%
  \foreignlanguage{ancientgreek}{κρίσις}%
}

\NewDocumentCommand{\Logoi}{}{%
  \foreignlanguage{ancientgreek}{Λόγοι}%
}

\NewDocumentCommand{\logoi}{}{%
  \foreignlanguage{ancientgreek}{λόγοι}%
}

\NewDocumentCommand{\Logos}{}{%
  \foreignlanguage{ancientgreek}{Λόγος}%
}

\NewDocumentCommand{\logos}{}{%
  \foreignlanguage{ancientgreek}{λόγος}%
}

\NewDocumentCommand{\Nous}{}{%
  \foreignlanguage{ancientgreek}{Νοῦς}%
}

\NewDocumentCommand{\nous}{}{%
  \foreignlanguage{ancientgreek}{νοῦς}%
}

\NewDocumentCommand{\orexis}{}{%
  \foreignlanguage{ancientgreek}{ὄρεξις}%
}

\NewDocumentCommand{\Orexis}{}{%
  \foreignlanguage{ancientgreek}{Ὄρεξις}%
}

\NewDocumentCommand{\Pathemata}{}{%
  \foreignlanguage{ancientgreek}{Παθήματα}%
}

\NewDocumentCommand{\pathemata}{}{%
  \foreignlanguage{ancientgreek}{παθήματα}%
}

\NewDocumentCommand{\Phantasiai}{}{%
  \foreignlanguage{ancientgreek}{Φαντασίαι}%
}

\NewDocumentCommand{\phantasiai}{}{%
  \foreignlanguage{ancientgreek}{φαντασίαι}%
}

\NewDocumentCommand{\Phantasia}{}{%
  \foreignlanguage{ancientgreek}{Φαντασία}%
}

\NewDocumentCommand{\phantasia}{}{%
  \foreignlanguage{ancientgreek}{φαντασία}%
}

\NewDocumentCommand{\Phantasmata}{}{%
  \foreignlanguage{ancientgreek}{Φαντάσματα}%
}

\NewDocumentCommand{\phantasmata}{}{%
  \foreignlanguage{ancientgreek}{φαντάσματα}%
}

\NewDocumentCommand{\Phantasma}{}{%
  \foreignlanguage{ancientgreek}{Φάντασμα}%
}

\NewDocumentCommand{\phantasma}{}{%
  \foreignlanguage{ancientgreek}{φάντασμα}%
}

\NewDocumentCommand{\Phronesis}{}{%
  \foreignlanguage{ancientgreek}{Φρόνησις}%
}

\NewDocumentCommand{\phronesis}{}{%
  \foreignlanguage{ancientgreek}{φρόνησις}%
}

\NewDocumentCommand{\Phronime}{}{%
  \foreignlanguage{ancientgreek}{Φρονίμη}%
}

\NewDocumentCommand{\phronime}{}{%
  \foreignlanguage{ancientgreek}{φρονίμη}%
}

\NewDocumentCommand{\Phronimoi}{}{%
  \foreignlanguage{ancientgreek}{Φρόνιμοι}%
}

\NewDocumentCommand{\phronimoi}{}{%
  \foreignlanguage{ancientgreek}{φρόνιμοι}%
}

\NewDocumentCommand{\Phronimos}{}{%
  \foreignlanguage{ancientgreek}{Φρόνιμος}%
}

\NewDocumentCommand{\phronimos}{}{%
  \foreignlanguage{ancientgreek}{φρόνιμος}%
}

\NewDocumentCommand{\Prohaireseis}{}{%
  \foreignlanguage{ancientgreek}{Προαιρέσεις}%
}

\NewDocumentCommand{\prohaireseis}{}{%
  \foreignlanguage{ancientgreek}{προαιρέσεις}%
}

\NewDocumentCommand{\Prohairesis}{}{%
  \foreignlanguage{ancientgreek}{Προαίρεσις}%
}

\NewDocumentCommand{\prohairesis}{}{%
  \foreignlanguage{ancientgreek}{προαίρεσις}%
}

\NewDocumentCommand{\Thumos}{}{%
  \foreignlanguage{ancientgreek}{Θυμός}%
}

\NewDocumentCommand{\thumos}{}{%
  \foreignlanguage{ancientgreek}{θυμός}%
}

\NewDocumentCommand{\doxastikon}{s}{%
  \foreignlanguage{ancientgreek}{\IfBooleanT{#1}{τὸ }δοξαστικόν}%
}

\NewDocumentCommand{\Doxastikon}{s}{%
  \IfBooleanTF{#1}{%
    \foreignlanguage{ancientgreek}{Τὸ δοξαστικόν}%
  }{%
    \foreignlanguage{ancientgreek}{Δοξαστικόν}%
  }%
}

\NewDocumentCommand{\ToDoxastikon}{}{%
  \foreignlanguage{ancientgreek}{Τὸ Δοξαστικόν}%
}

\NewDocumentCommand{\kalon}{s}{%
  \foreignlanguage{ancientgreek}{\IfBooleanT{#1}{τὸ }καλόν}%
}

\NewDocumentCommand{\Kalon}{s}{%
  \IfBooleanTF{#1}{%
    \foreignlanguage{ancientgreek}{Τὸ καλόν}%
  }{%
    \foreignlanguage{ancientgreek}{Καλόν}%
  }%
}

\NewDocumentCommand{\ToKalon}{}{%
  \foreignlanguage{ancientgreek}{Τὸ Καλόν}%
}

\NewDocumentCommand{\logistikon}{s}{%
  \foreignlanguage{ancientgreek}{\IfBooleanT{#1}{τὸ }λογιστικόν}%
}

\NewDocumentCommand{\Logistikon}{s}{%
  \IfBooleanTF{#1}{%
    \foreignlanguage{ancientgreek}{Τὸ λογιστικόν}%
  }{%
    \foreignlanguage{ancientgreek}{Λογιστικόν}%
  }%
}

\NewDocumentCommand{\ToLogistikon}{}{%
  \foreignlanguage{ancientgreek}{Τὸ Λογιστικόν}%
}

\ifbool{rh@translit}{% TODO add hyphenation patterns {{{3
  \RenewDocumentCommand{\boulesis}{}{\alialingua{boulēsis}}
  \RenewDocumentCommand{\Boulesis}{}{\alialingua{Boulēsis}}
  \RenewDocumentCommand{\bouleseis}{}{\alialingua{boulēseis}}
  \RenewDocumentCommand{\Bouleseis}{}{\alialingua{Boulēseis}}
  \RenewDocumentCommand{\nous}{}{\alialingua{nous}}
  \RenewDocumentCommand{\Nous}{}{\alialingua{Nous}}
  \RenewDocumentCommand{\phantasiai}{}{\alialingua{phantasiai}}
  \RenewDocumentCommand{\Phantasiai}{}{\alialingua{Phantasiai}}
  \RenewDocumentCommand{\phantasia}{}{\alialingua{phantasia}}
  \RenewDocumentCommand{\Phantasia}{}{\alialingua{Phantasia}}
  \RenewDocumentCommand{\phantasmata}{}{\alialingua{phantasmata}}
  \RenewDocumentCommand{\Phantasmata}{}{\alialingua{Phantasmata}}
  \RenewDocumentCommand{\phantasma}{}{\alialingua{phantasma}}
  \RenewDocumentCommand{\Phantasma}{}{\alialingua{Phantasma}}
  \RenewDocumentCommand{\phronesis}{}{\alialingua{phronēsis}}
  \RenewDocumentCommand{\Phronesis}{}{\alialingua{Phronēsis}}
  \RenewDocumentCommand{\thumos}{}{\alialingua{thumos}}
  \RenewDocumentCommand{\Thumos}{}{\alialingua{Thumos}}
}{}
% }}}3
% }}}2

% }}}1
